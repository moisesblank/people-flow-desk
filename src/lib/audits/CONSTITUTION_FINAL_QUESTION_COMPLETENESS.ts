// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìú CONSTITUI√á√ÉO DE COMPLETUDE FINAL DA QUEST√ÉO v1.0.0
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Status: VIGENTE, IMUT√ÅVEL E PERMANENTE
// Autoridade: OWNER (moisesblank@gmail.com)
// Data: 2026-01-02
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * üèõÔ∏è PRINC√çPIO FUNDAMENTAL
 * 
 * "O arquivo Excel pode ser incompleto.
 *  A entidade Quest√£o final NUNCA pode ser incompleta."
 * 
 * Este princ√≠pio √© IMUT√ÅVEL e governa toda a l√≥gica de importa√ß√£o de quest√µes.
 */

export const CONSTITUTION_FINAL_QUESTION_COMPLETENESS = {
  version: '1.0.0',
  status: 'ACTIVE_AND_IMMUTABLE',
  authority: 'OWNER',
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // REGRA DE IDENTIDADE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  identity_rule: {
    description: 'MACRO define a identidade √∫nica de uma quest√£o.',
    rules: [
      'Cada quest√£o DEVE ter exatamente 1 MACRO.',
      'MACRO √© obrigat√≥rio e n√£o pode ser null.',
      'MACRO nunca √© alterado automaticamente pela IA.',
      'MACRO s√≥ pode ser alterado por a√ß√£o humana expl√≠cita.',
    ],
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // REGRA DE COMPLETUDE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  completeness_rule: {
    description: 'Todas as camadas de classifica√ß√£o e metadados devem existir na entidade Quest√£o final.',
    mandatory_fields: [
      'macro',      // OBRIGAT√ìRIO - Identidade
      'micro',      // A IA deve inferir se vazio
      'tema',       // A IA deve inferir se vazio
      'subtema',    // A IA deve inferir se vazio
      'difficulty', // A IA deve inferir se vazio
      'explanation',// A IA deve gerar se vazio
      'banca',      // A IA deve inferir ou usar 'Autoral' se vazio
      'ano',        // A IA deve inferir ou usar ano atual se vazio
    ],
    optional_fields: [
      'image_url',  // A IA avalia e associa quando aplic√°vel
      'tags',       // Podem ser m√∫ltiplas e livres
    ],
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // REGRA EXCEL vs ENTIDADE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  excel_vs_entity_rule: {
    description: 'Opcional no Excel N√ÉO significa opcional no sistema.',
    rules: [
      'Campos podem estar vazios no arquivo Excel.',
      'Campos DEVEM estar preenchidos na entidade Quest√£o final.',
      'Nenhuma quest√£o pode ser salva com metadados obrigat√≥rios ausentes.',
    ],
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // COMPORTAMENTO DA IA
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  ai_behavior: {
    mode: 'AGENT',
    authority: 'ASSISTIVE_ONLY',
    rules: [
      'IA DEVE inferir campos ausentes baseado na an√°lise de conte√∫do real.',
      'IA DEVE usar a realidade pedag√≥gica da plataforma ao inferir.',
      'IA DEVE atribuir a classifica√ß√£o mais equivalente quando match exato n√£o √© expl√≠cito.',
      'IA N√ÉO PODE deixar nenhum campo infer√≠vel vazio.',
      'IA DEVE gerar explica√ß√µes compat√≠veis com o conte√∫do quando ausentes.',
    ],
    
    // Mapeamento de campos e fallbacks
    inference_mapping: {
      macro: { 
        required: true, 
        fallback: 'Qu√≠mica Geral',
        ai_can_change: false, // IA nunca altera MACRO
      },
      micro: { 
        required: false, // CORRE√á√ÉO v10.0.1: N√£o obrigat√≥rio, IA infere
        fallback: '',    // Vazio para permitir infer√™ncia pela IA
        ai_can_change: true,
      },
      tema: { 
        required: false, // CORRE√á√ÉO v10.0.1: N√£o obrigat√≥rio, IA infere
        fallback: '',    // Vazio para permitir infer√™ncia pela IA
        ai_can_change: true,
      },
      subtema: { 
        required: false, // CORRE√á√ÉO v10.0.1: N√£o obrigat√≥rio, IA infere
        fallback: '',    // Vazio para permitir infer√™ncia pela IA
        ai_can_change: true,
      },
      difficulty: { 
        required: true, 
        fallback: 'm√©dio',
        ai_can_change: true,
      },
      banca: { 
        required: true, 
        fallback: 'Autoral',
        ai_can_change: true,
      },
      ano: { 
        required: true, 
        fallback: new Date().getFullYear(),
        ai_can_change: true,
      },
      explanation: { 
        required: true, 
        fallback: 'Resolu√ß√£o comentada n√£o dispon√≠vel. Consulte o material de apoio.',
        ai_can_change: true,
        ai_should_generate: true,
      },
    },
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // VALIDA√á√ÉO E BLOQUEIO
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  validation_and_blocking: {
    rules: [
      'Bloquear persist√™ncia de qualquer entidade Quest√£o com campos obrigat√≥rios ausentes.',
      'Bloquear conclus√£o de importa√ß√£o se infer√™ncia da IA falhar.',
      'Exigir completude da IA antes de marcar importa√ß√£o como bem-sucedida.',
    ],
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // AUDITORIA E LOGGING
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  audit_and_logging: {
    rules: [
      'Registrar todos os campos inferidos pela IA.',
      'Armazenar confidence score para cada campo inferido.',
      'Registrar valor original do Excel vs valor final inferido.',
      'Manter trilha de auditoria completa para revis√£o futura.',
    ],
    storage: {
      field: 'campos_inferidos',
      format: 'campo:metodo',
      examples: [
        'micro:ai_inference',
        'tema:ai_inference',
        'difficulty:ai_inference',
        'explanation:ai_generated',
        'banca:fallback_autoral',
        'ano:fallback_current_year',
      ],
    },
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CL√ÅUSULA DE IMUTABILIDADE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  immutability_clause: {
    description: 'Esta pol√≠tica √© permanente e n√£o pode ser contornada.',
    rules: [
      'Nenhuma feature pode contornar esta regra de completude.',
      'Nenhuma atualiza√ß√£o futura pode permitir entidades Quest√£o incompletas.',
      'Qualquer viola√ß√£o √© considerada erro cr√≠tico do sistema.',
      'Mudan√ßas requerem revis√£o arquitetural expl√≠cita.',
    ],
  },
} as const;

/**
 * Tipo para validar completude de uma quest√£o
 */
export interface CompleteQuestion {
  // Campos de identifica√ß√£o
  id: string;
  question_text: string;
  options: { id: string; text: string; image_url?: string }[];
  correct_answer: string;
  
  // Campos OBRIGAT√ìRIOS (n√£o podem ser null/undefined)
  macro: string;           // Identidade √∫nica
  micro: string;           // Camada transversal
  tema: string;            // Camada transversal
  subtema: string;         // Camada transversal
  difficulty: string;      // f√°cil | m√©dio | dif√≠cil
  explanation: string;     // Resolu√ß√£o comentada
  banca: string;           // Banca ou "Autoral"
  ano: number;             // Ano da quest√£o
  
  // Campos opcionais
  image_url?: string;
  image_urls?: string[];
  tags?: string[];
  competencia_enem?: string;
  habilidade_enem?: string;
  nivel_cognitivo?: string;
  tempo_medio_segundos?: number;
  origem?: string;
  
  // Metadados de rastreabilidade
  campos_inferidos: string[];
}

/**
 * Valida se uma quest√£o est√° completa segundo a pol√≠tica
 */
export function validateQuestionCompleteness(question: any): { 
  isComplete: boolean; 
  missingFields: string[]; 
  warnings: string[] 
} {
  const missingFields: string[] = [];
  const warnings: string[] = [];
  
  const requiredFields = CONSTITUTION_FINAL_QUESTION_COMPLETENESS.ai_behavior.inference_mapping;
  
  for (const [field, config] of Object.entries(requiredFields)) {
    if (config.required) {
      const value = question[field];
      if (value === null || value === undefined || (typeof value === 'string' && !value.trim())) {
        missingFields.push(field);
      }
    }
  }
  
  // Valida√ß√µes adicionais
  if (!question.question_text?.trim()) {
    missingFields.push('question_text');
  }
  
  const filledOptions = question.options?.filter((o: any) => o.text?.trim())?.length || 0;
  if (filledOptions < 2) {
    missingFields.push('options (m√≠nimo 2)');
  }
  
  // Warnings informativos
  if (question.campos_inferidos?.length > 0) {
    warnings.push(`${question.campos_inferidos.length} campos foram inferidos pela IA`);
  }
  
  return {
    isComplete: missingFields.length === 0,
    missingFields,
    warnings,
  };
}

/**
 * Aplica fallbacks para campos ausentes
 */
export function applyCompletenessFallbacks(question: any): any {
  const updated = { ...question };
  const currentYear = new Date().getFullYear();
  const mapping = CONSTITUTION_FINAL_QUESTION_COMPLETENESS.ai_behavior.inference_mapping;
  
  const camposInferidos = [...(question.campos_inferidos || [])];
  
  if (!updated.macro?.trim()) {
    updated.macro = mapping.macro.fallback;
    camposInferidos.push('macro:fallback_default');
  }
  
  // CORRE√á√ÉO v10.0.1: N√ÉO aplicar fallbacks gen√©ricos para MICRO/TEMA/SUBTEMA
  // Deixar vazio para que a IA possa inferir valores can√¥nicos da taxonomia
  if (!updated.micro?.trim()) {
    updated.micro = ''; // Vazio para infer√™ncia pela IA
    camposInferidos.push('micro:empty_for_ai_inference');
  }
  
  if (!updated.tema?.trim()) {
    updated.tema = ''; // Vazio para infer√™ncia pela IA
    camposInferidos.push('tema:empty_for_ai_inference');
  }
  
  if (!updated.subtema?.trim()) {
    updated.subtema = ''; // Vazio para infer√™ncia pela IA (opcional)
    camposInferidos.push('subtema:empty_for_ai_inference');
  }
  
  if (!updated.difficulty?.trim()) {
    updated.difficulty = mapping.difficulty.fallback;
    camposInferidos.push('difficulty:fallback_default');
  }
  
  if (!updated.banca?.trim()) {
    updated.banca = mapping.banca.fallback;
    camposInferidos.push('banca:fallback_autoral');
  }
  
  if (!updated.ano || isNaN(updated.ano)) {
    updated.ano = currentYear;
    camposInferidos.push('ano:fallback_current_year');
  }
  
  if (!updated.explanation?.trim()) {
    updated.explanation = mapping.explanation.fallback as string;
    camposInferidos.push('explanation:fallback_default');
  }
  
  updated.campos_inferidos = camposInferidos;
  
  return updated;
}

export default CONSTITUTION_FINAL_QUESTION_COMPLETENESS;
