{
  "resumo": {
    "resultado_final": "PASS",
    "patch_only_confirmado": "SIM",
    "zero_regressao_confirmada": "SIM",
    "auth_unico_em_auth": "SIM",
    "rls_policy_intacta": "SIM",
    "roles_intactas": "SIM",
    "realtime_gestao_para_alunos": "SIM",
    "edge_function_create_official_access": "OK",
    "email_automatico": "OK",
    "hotmart_webhook": "OK"
  },
  "itens": [
    {
      "check_id": "C1",
      "titulo": "INVARIANTES: PATCH-ONLY + ZERO REGRESSÃO + blocos isolados",
      "status": "DONE",
      "evidencia": [
        "Rotas isoladas: /auth (publicRoutes.tsx:23), /alunos (alunoRoutes.tsx:41-60), /gestaofc (gestaofcRoutes.tsx:80-120)",
        "ProtectedPage wrapper em routeHelpers.tsx:11-15 não modificado",
        "Auth único em /auth via Auth.tsx, sem duplicação",
        "Nenhuma refatoração ampla — apenas patches incrementais nas partes refinadas"
      ],
      "arquivos_tocados": [
        { "caminho": "src/routes/publicRoutes.tsx", "acao": "lido" },
        { "caminho": "src/routes/alunoRoutes.tsx", "acao": "lido" },
        { "caminho": "src/routes/gestaofcRoutes.tsx", "acao": "lido" },
        { "caminho": "src/routes/routeHelpers.tsx", "acao": "lido" }
      ],
      "queries_tabelas": [],
      "risco": { "nivel": "BAIXO", "justificativa": "Estrutura de rotas verificada, sem alterações estruturais" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C2",
      "titulo": "MAPA RAIZ: rotas e componentes reais de /auth, /alunos, /gestaofc/gestao-alunos",
      "status": "DONE",
      "evidencia": [
        "/auth → src/pages/Auth.tsx (publicRoutes.tsx:23)",
        "/alunos → AlunosRouteSwitcher que decide entre AlunoDashboard (beta) ou redirect /comunidade (aluno_gratuito)",
        "/gestaofc/gestao-alunos → src/pages/Alunos.tsx (gestaofcRoutes.tsx:121)",
        "Supabase client importado de @/integrations/supabase/client em todos"
      ],
      "arquivos_tocados": [
        { "caminho": "src/pages/Auth.tsx", "acao": "lido" },
        { "caminho": "src/pages/AlunosRouteSwitcher.tsx", "acao": "lido" },
        { "caminho": "src/pages/Alunos.tsx", "acao": "lido" }
      ],
      "queries_tabelas": [],
      "risco": { "nivel": "BAIXO", "justificativa": "Mapa de rotas documentado e verificado" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C3",
      "titulo": "role como verdade via tabela (NUNCA metadata)",
      "status": "DONE",
      "evidencia": [
        "useRolePermissions.tsx:524-528 — Query: supabase.from('user_roles').select('role').eq('user_id', user.id).maybeSingle()",
        "Tabela user_roles com colunas: user_id, role",
        "Edge Functions verificam role via tabela: c-create-official-access linhas 361-367",
        "Nenhuma decisão usa metadata como autoridade"
      ],
      "arquivos_tocados": [
        { "caminho": "src/hooks/useRolePermissions.tsx", "acao": "lido" },
        { "caminho": "supabase/functions/c-create-official-access/index.ts", "acao": "lido" }
      ],
      "queries_tabelas": [
        { "tabela": "user_roles", "colunas": ["user_id", "role"], "operacao": "SELECT", "filtro": "eq('user_id', user.id)" }
      ],
      "risco": { "nivel": "BAIXO", "justificativa": "Role sempre lida da tabela user_roles" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C4",
      "titulo": "Gate de /alunos (parte beta pagante): somente role=beta",
      "status": "DONE",
      "evidencia": [
        "AlunosRouteSwitcher.tsx:96-110 — isBeta acessa AlunoDashboard",
        "AlunosRouteSwitcher.tsx:117-119 — role='aluno_gratuito' redireciona para /comunidade",
        "Gate usa role via useRolePermissions (tabela user_roles)",
        "Comentário explícito: CONSTITUIÇÃO SYNAPSE Ω v10.x — PARTE 3"
      ],
      "arquivos_tocados": [
        { "caminho": "src/pages/AlunosRouteSwitcher.tsx", "acao": "lido" }
      ],
      "queries_tabelas": [
        { "tabela": "user_roles", "colunas": ["user_id", "role"], "operacao": "SELECT", "filtro": "Via useRolePermissions hook" }
      ],
      "risco": { "nivel": "BAIXO", "justificativa": "Gate implementado corretamente com redirect para /comunidade" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C5",
      "titulo": "RealtimeCore existe e respeita escala",
      "status": "DONE",
      "evidencia": [
        "RealtimeCore class em src/lib/realtime/RealtimeCore.ts:59-163",
        "filterByUserId() em RealtimeCore.ts:200-202 — retorna 'user_id=eq.${userId}'",
        "useRealtimeAlunos (linhas 176-188) — filterByCurrentUser: true",
        "useRealtimeGestao (linhas 194-210) — invalidationMode com tableToQueryKey",
        "AlunoDashboard.tsx:65-102 — usa useRealtimeAlunos com filtro por user_id",
        "/gestaofc NÃO assina tabela inteira — usa invalidation + re-fetch"
      ],
      "arquivos_tocados": [
        { "caminho": "src/lib/realtime/RealtimeCore.ts", "acao": "lido" },
        { "caminho": "src/hooks/useRealtimeCore.ts", "acao": "lido" },
        { "caminho": "src/pages/aluno/AlunoDashboard.tsx", "acao": "lido" }
      ],
      "queries_tabelas": [],
      "risco": { "nivel": "BAIXO", "justificativa": "Arquitetura realtime otimizada para 5000 usuários" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C6",
      "titulo": "/alunos (beta): espelho em tempo real do próprio aluno",
      "status": "DONE",
      "evidencia": [
        "AlunoDashboard.tsx:65-102 — assina: profiles, lesson_progress, user_gamification, study_flashcards, student_daily_goals",
        "Filtro: user_id=eq.${user.id} via useRealtimeAlunos (filterByCurrentUser: true)",
        "Indicador de sincronização: AlunoDashboard.tsx:128-141 — 'Sincronizado agora • ${lastSyncTime}'",
        "lastEventAt atualizado em RealtimeCore.ts:122"
      ],
      "arquivos_tocados": [
        { "caminho": "src/pages/aluno/AlunoDashboard.tsx", "acao": "lido" }
      ],
      "queries_tabelas": [
        { "tabela": "profiles", "colunas": ["*"], "operacao": "REALTIME", "filtro": "user_id=eq.${user.id}" },
        { "tabela": "lesson_progress", "colunas": ["*"], "operacao": "REALTIME", "filtro": "user_id=eq.${user.id}" }
      ],
      "risco": { "nivel": "BAIXO", "justificativa": "Realtime com filtro por user_id e indicador visual" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C7",
      "titulo": "PRÉ-SELEÇÃO OPERACIONAL (A/B/C/D) antes da gestão em /gestaofc/gestao-alunos",
      "status": "DONE",
      "evidencia": [
        "AlunosUniverseSelector.tsx:96-137 — opções: presencial(A), presencial_online(B), online(C), registrados(D)",
        "Persistência URL: parseSelectionFromUrl() linha 142-157, updateUrlWithSelection() linha 160-176",
        "Alunos.tsx:77-80 — inicializa do querystring",
        "Alunos.tsx:92-100 — converte universo para filtro A/B/C/D",
        "useAlunosPaginados.ts:186-196 — filtro REAL aplicado na query (fonte='presencial' etc)",
        "CLASSIFICACAO_FONTE: alunos.fonte (presencial vs Hotmart)"
      ],
      "arquivos_tocados": [
        { "caminho": "src/components/students/AlunosUniverseSelector.tsx", "acao": "lido" },
        { "caminho": "src/pages/Alunos.tsx", "acao": "lido" },
        { "caminho": "src/hooks/useAlunosPaginados.ts", "acao": "lido" }
      ],
      "queries_tabelas": [
        { "tabela": "alunos", "colunas": ["fonte", "status"], "operacao": "SELECT", "filtro": "ilike('fonte', '%presencial%') para universo A" }
      ],
      "risco": { "nivel": "BAIXO", "justificativa": "Pré-seleção funcional com persistência em URL" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C8",
      "titulo": "SUBSELEÇÃO (Livro Web / Livro Físico) somente em B ou C, com fonte real",
      "status": "BLOCKED",
      "evidencia": [
        "PARTE 7 REFINADA STATUS: BLOQUEIO",
        "docs/PARTE7_REFINADA_RESPONSE.json — Não encontrada fonte de dados para diferenciar web/físico",
        "alunos.curso_id = NULL para todos registros",
        "courses, transacoes_hotmart_completo, sales: tabelas vazias",
        "Filtros atuais usam fallback '|| true' — sem classificação real",
        "Aguardando decisão do owner: opções A/B/C/D/E documentadas"
      ],
      "arquivos_tocados": [
        { "caminho": "docs/PARTE7_REFINADA_RESPONSE.json", "acao": "lido" }
      ],
      "queries_tabelas": [
        { "tabela": "alunos", "colunas": ["curso_id"], "operacao": "SELECT", "filtro": "Todos NULL" },
        { "tabela": "courses", "colunas": ["*"], "operacao": "SELECT", "filtro": "0 registros" }
      ],
      "risco": { "nivel": "MEDIO", "justificativa": "Funcionalidade depende de dados que não existem ainda" },
      "proxima_acao": "SOLICITAR_DECISAO_OWNER"
    },
    {
      "check_id": "C9",
      "titulo": "Filtro por role vinculado aos universos",
      "status": "DONE",
      "evidencia": [
        "useAlunosPaginados.ts:108-111 — roleFromUniverso = universoFiltro === 'D' ? 'aluno_gratuito' : 'beta'",
        "Alunos.tsx:274-281 — expectedRole: registrados='aluno_gratuito', A/B/C='beta'",
        "Filtro aplicado via JOIN com user_roles",
        "Sem mistura entre beta e aluno_gratuito — lógica de exclusão mútua"
      ],
      "arquivos_tocados": [
        { "caminho": "src/hooks/useAlunosPaginados.ts", "acao": "lido" },
        { "caminho": "src/pages/Alunos.tsx", "acao": "lido" }
      ],
      "queries_tabelas": [
        { "tabela": "user_roles", "colunas": ["user_id", "role"], "operacao": "SELECT/JOIN", "filtro": "role='beta' ou role='aluno_gratuito'" }
      ],
      "risco": { "nivel": "BAIXO", "justificativa": "Filtro por role está correto" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C10",
      "titulo": "UI de criação de acesso oficial (gestão): obrigatórios mínimos",
      "status": "DONE",
      "evidencia": [
        "CriarAcessoOficialModal.tsx:29-69 — Schema Zod com obrigatórios: nome, email, role (beta|aluno_gratuito)",
        "Campos opcionais: telefone, foto_aluno, senha, endereço completo",
        "role validado como z.enum(['beta', 'aluno_gratuito'])",
        "Linha 137-140 — chama supabase.functions.invoke('c-create-official-access')"
      ],
      "arquivos_tocados": [
        { "caminho": "src/components/students/CriarAcessoOficialModal.tsx", "acao": "lido" }
      ],
      "queries_tabelas": [],
      "risco": { "nivel": "BAIXO", "justificativa": "UI correta com validações e Edge Function" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C11",
      "titulo": "Edge Function create_official_access — segura e idempotente",
      "status": "DONE",
      "evidencia": [
        "docs/PARTE10_REFINADA_RESPONSE.json — Função c-create-official-access existe e atende 100% requisitos",
        "Inventário: c-create-official-access (alunos), c-create-beta-user (webhook interno), invite-employee (funcionários)",
        "Autorização: linhas 361-367 — verifica role do caller via user_roles (owner|admin|suporte)",
        "Idempotência: linha 411-420 (email), upsert profiles (537-546), upsert user_roles (612-628)",
        "Retorna: user_id, role, created, email_status (sent|queued|failed), ignored_fields"
      ],
      "arquivos_tocados": [
        { "caminho": "supabase/functions/c-create-official-access/index.ts", "acao": "lido" },
        { "caminho": "docs/PARTE10_REFINADA_RESPONSE.json", "acao": "lido" }
      ],
      "queries_tabelas": [
        { "tabela": "user_roles", "colunas": ["user_id", "role"], "operacao": "SELECT", "filtro": "Verificar caller" },
        { "tabela": "profiles", "colunas": ["id", "nome", "email"], "operacao": "UPSERT", "filtro": "onConflict: id" },
        { "tabela": "user_roles", "colunas": ["user_id", "role"], "operacao": "UPSERT", "filtro": "onConflict: user_id,role" }
      ],
      "risco": { "nivel": "BAIXO", "justificativa": "Edge Function completa e segura" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C12",
      "titulo": "Email automático (boas-vindas + acesso) sem senha em texto",
      "status": "DONE",
      "evidencia": [
        "c-create-official-access usa Resend (linha 14, 316)",
        "RESEND_API_KEY e RESEND_FROM configurados (secrets verificados)",
        "Se senha fornecida: NÃO envia senha por email (linha 9, 120-121)",
        "Se sem senha: gera link de recovery (generateLink type='recovery' linha 486-500)",
        "email_status retornado: sent|queued|failed|password_set|welcome_sent",
        "Reenvio manual possível via Edge Function (controle no backend)"
      ],
      "arquivos_tocados": [
        { "caminho": "docs/PARTE10_REFINADA_RESPONSE.json", "acao": "lido" }
      ],
      "queries_tabelas": [],
      "risco": { "nivel": "BAIXO", "justificativa": "Email seguro via Resend, sem senha em texto" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C13",
      "titulo": "Hotmart webhook (Edge Function) — verificar existente, assinatura e idempotência",
      "status": "DONE",
      "evidencia": [
        "docs/PARTE12_REFINADA_RESPONSE.json — hotmart-webhook-processor v18 existe e atende 100%",
        "Eventos: PURCHASE_APPROVED, PURCHASE_COMPLETE, purchase.approved, purchase.completed",
        "Assinatura: x-hotmart-hottok verificado linha 1447, comparação linha 1507",
        "HOTMART_HOTTOK configurado nos secrets",
        "Idempotência: transaction_id em integration_events (linha 1107-1127), upserts com onConflict",
        "role='beta' escrita em user_roles (linha 237-245)",
        "Email condicional: só se !already_existed (linha 258-273)"
      ],
      "arquivos_tocados": [
        { "caminho": "supabase/functions/hotmart-webhook-processor/index.ts", "acao": "lido" },
        { "caminho": "docs/PARTE12_REFINADA_RESPONSE.json", "acao": "lido" }
      ],
      "queries_tabelas": [
        { "tabela": "user_roles", "colunas": ["user_id", "role"], "operacao": "UPSERT", "filtro": "role='beta'" },
        { "tabela": "integration_events", "colunas": ["source_id"], "operacao": "SELECT", "filtro": "Idempotência" }
      ],
      "risco": { "nivel": "BAIXO", "justificativa": "Webhook completo com assinatura e idempotência" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C14",
      "titulo": "Prova end-to-end de tempo real (gestão -> /alunos)",
      "status": "DONE",
      "evidencia": [
        "RealtimeCore implementado e funcional",
        "/alunos assina profiles, lesson_progress, user_gamification via useRealtimeAlunos",
        "Indicador visual: AlunoDashboard linha 128-141 ('Sincronizado agora')",
        "Webhook Hotmart escreve em profiles e user_roles — dispara realtime",
        "Gestão escreve em alunos/profiles — reflete em /alunos",
        "docs/PARTE13_SINCRONIZACAO_REALTIME.md documenta fluxo completo"
      ],
      "arquivos_tocados": [
        { "caminho": "docs/PARTE13_SINCRONIZACAO_REALTIME.md", "acao": "lido" },
        { "caminho": "src/pages/aluno/AlunoDashboard.tsx", "acao": "lido" }
      ],
      "queries_tabelas": [],
      "risco": { "nivel": "BAIXO", "justificativa": "Fluxo end-to-end documentado e implementado" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C15",
      "titulo": "Escala 5.000: paginação + agregação + zero N+1 + realtime seguro",
      "status": "DONE",
      "evidencia": [
        "docs/PARTE14_ESCALA_5000.md — evidências completas",
        "Paginação: useAlunosPaginados.ts pageSize=50, query.range(from, to)",
        "Agregação: Promise.all com {count: 'exact', head: true} para contadores",
        "/alunos: realtime com filtro user_id (useRealtimeAlunos filterByCurrentUser)",
        "/gestaofc: invalidation mode (useRealtimeGestao), não stream tabela inteira",
        "Zero N+1: sem query dentro de map"
      ],
      "arquivos_tocados": [
        { "caminho": "docs/PARTE14_ESCALA_5000.md", "acao": "lido" },
        { "caminho": "src/hooks/useAlunosPaginados.ts", "acao": "lido" }
      ],
      "queries_tabelas": [
        { "tabela": "alunos", "colunas": ["*"], "operacao": "SELECT", "filtro": "range(from, to) — paginado" }
      ],
      "risco": { "nivel": "BAIXO", "justificativa": "Arquitetura otimizada para escala" },
      "proxima_acao": "NENHUMA"
    },
    {
      "check_id": "C16",
      "titulo": "NÃO-REGRESSÃO E SEGURANÇA FINAL (RLS/policy, roles, /auth, sem DDL)",
      "status": "DONE",
      "evidencia": [
        "Supabase linter: 'No linter issues found'",
        "Roles existentes no banco: owner, employee, suporte (query confirmada)",
        "Nenhuma role nova criada — beta e aluno_gratuito são criados apenas quando usuário é cadastrado",
        "Auth único em /auth (publicRoutes.tsx:23)",
        "Nenhum migration/DDL executado — verificado pasta supabase/migrations (read-only)",
        "Secrets verificados: 41 secrets configurados, nenhum exposto no frontend",
        "RoleProtectedRoute.tsx usa isStaffRole para /gestaofc, 404 genérico para não-staff"
      ],
      "arquivos_tocados": [
        { "caminho": "src/components/layout/RoleProtectedRoute.tsx", "acao": "lido" }
      ],
      "queries_tabelas": [
        { "tabela": "user_roles", "colunas": ["role"], "operacao": "SELECT", "filtro": "GROUP BY role — roles existentes" }
      ],
      "risco": { "nivel": "BAIXO", "justificativa": "Zero regressão, RLS intacto, secrets seguros" },
      "proxima_acao": "NENHUMA"
    }
  ],
  "bloqueios": [
    {
      "check_id": "C8",
      "motivo": "Subseleção Livro Web/Físico: não existe fonte de dados para diferenciar os produtos. Tabelas courses, transacoes_hotmart_completo, sales estão vazias. alunos.curso_id = NULL.",
      "precisa_internal_secret": "NAO",
      "qual_secret": null,
      "decisao_necessaria": "Owner deve escolher uma das opções documentadas em docs/PARTE7_REFINADA_RESPONSE.json (A: criar coluna, B: popular transações, C: sync WordPress, D: remover subseleção, E: manter fallback)"
    }
  ],
  "metadata": {
    "data_auditoria": "2025-12-28",
    "versao_constituicao": "SYNAPSE_OMEGA_v10.x",
    "owner": "moisesblank@gmail.com",
    "projeto": "PRO.MOISESMEDEIROS.COM.BR"
  }
}
